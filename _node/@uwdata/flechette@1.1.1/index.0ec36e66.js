const ut=Uint8Array.of(65,82,82,79,87,49),S={V1:0,V2:1,V3:2,V4:3,V5:4},Zt={Little:0,Big:1},v={NONE:0,Schema:1,DictionaryBatch:2,RecordBatch:3,Tensor:4,SparseTensor:5},c={Dictionary:-1,NONE:0,Null:1,Int:2,Float:3,Binary:4,Utf8:5,Bool:6,Decimal:7,Date:8,Time:9,Timestamp:10,Interval:11,List:12,Struct:13,Union:14,FixedSizeBinary:15,FixedSizeList:16,Map:17,Duration:18,LargeBinary:19,LargeUtf8:20,LargeList:21,RunEndEncoded:22,BinaryView:23,Utf8View:24,ListView:25,LargeListView:26},z={HALF:0,SINGLE:1,DOUBLE:2},j={DAY:0,MILLISECOND:1},b={SECOND:0,MILLISECOND:1,MICROSECOND:2,NANOSECOND:3},B={YEAR_MONTH:0,DAY_TIME:1,MONTH_DAY_NANO:2},G={Sparse:0,Dense:1},J=Uint8Array,vt=Uint16Array,xt=Uint32Array,ot=BigUint64Array,dt=Int8Array,te=Int16Array,x=Int32Array,O=BigInt64Array,ee=Float32Array,tt=Float64Array;function xn(e,t){const n=Math.log2(e)-3;return(t?[dt,te,x,O]:[J,vt,xt,ot])[n]}const On=Object.getPrototypeOf(Int8Array);function ne(e){return e instanceof On}function se(e){return Array.isArray(e)||ne(e)}function Ot(e){return e===O||e===ot}function Lt(e,t){let n=0,s=e.length;if(s<=2147483648)do{const r=n+s>>>1;e[r]<=t?n=r+1:s=r}while(n<s);else do{const r=Math.trunc((n+s)/2);e[r]<=t?n=r+1:s=r}while(n<s);return n}function Ln(e,t=1){return(e*t+7&-8)/t}function En(e,t=e.length){const n=Ln(t,e.BYTES_PER_ELEMENT);return e.length>n?e.subarray(0,n):e.length<n?re(e,n):e}function re(e,t,n=0){const s=new e.constructor(t);return s.set(e,n),s}function ie(e,t,n){for(;e.length<=t;)e=re(e,e.length<<1,n?e.length:0);return e}function Dn(e){return e instanceof Date}function An(e){return typeof e[Symbol.iterator]=="function"}function Et(e,t,n){if(t(e))return e;throw new Error(n(e))}function L(e,t,n){return t=Array.isArray(t)?t:Object.values(t),Et(e,s=>t.includes(s),n??(()=>`${e} must be one of ${t}`))}function ae(e,t){for(const[n,s]of Object.entries(e))if(s===t)return n;return"<Unknown>"}const q=e=>`Unsupported data type: "${ae(c,e)}" (id ${e})`,X=(e,t,n=!0,s=null)=>({name:e,type:t,nullable:n,metadata:s});function ce(e){return Object.hasOwn(e,"name")&&ue(e.type)}function ue(e){return typeof e?.typeId=="number"}function M(e,t="",n=!0){return ce(e)?e:X(t,Et(e,ue,()=>"Data type expected."),n)}const lt=e=>({typeId:e}),Dt=(e,t,n=!1,s=-1)=>({typeId:c.Dictionary,id:s,dictionary:e,indices:t||et(),ordered:n}),oe=()=>lt(c.Null),C=(e=32,t=!0)=>({typeId:c.Int,bitWidth:L(e,[8,16,32,64]),signed:t,values:xn(e,t)}),At=()=>C(8),Nt=()=>C(16),et=()=>C(32),St=()=>C(64),de=()=>C(8,!1),le=()=>C(16,!1),he=()=>C(32,!1),fe=()=>C(64,!1),nt=(e=2)=>({typeId:c.Float,precision:L(e,z),values:[vt,ee,tt][e]}),Nn=()=>nt(z.HALF),ye=()=>nt(z.SINGLE),ht=()=>nt(z.DOUBLE),pe=()=>({typeId:c.Binary,offsets:x}),Bt=()=>({typeId:c.Utf8,offsets:x}),Ie=()=>lt(c.Bool),be=(e,t,n=128)=>({typeId:c.Decimal,precision:e,scale:t,bitWidth:L(n,[128,256]),values:ot}),ft=e=>({typeId:c.Date,unit:L(e,j),values:e===j.DAY?x:O}),ge=()=>ft(j.DAY),Sn=()=>ft(j.MILLISECOND),K=(e=b.MILLISECOND,t=32)=>({typeId:c.Time,unit:L(e,b),bitWidth:L(t,[32,64]),values:t===32?x:O}),Bn=()=>K(b.SECOND,32),Mn=()=>K(b.MILLISECOND,32),Cn=()=>K(b.MICROSECOND,64),Un=()=>K(b.NANOSECOND,64),Mt=(e=b.MILLISECOND,t=null)=>({typeId:c.Timestamp,unit:L(e,b),timezone:t,values:O}),me=(e=B.MONTH_DAY_NANO)=>({typeId:c.Interval,unit:L(e,B),values:e===B.MONTH_DAY_NANO?void 0:x}),Ct=e=>({typeId:c.List,children:[M(e)],offsets:x}),yt=e=>({typeId:c.Struct,children:Array.isArray(e)&&ce(e[0])?e:Object.entries(e).map(([t,n])=>X(t,n))}),we=(e,t,n,s)=>(n??=t.map((r,i)=>i),{typeId:c.Union,mode:L(e,G),typeIds:n,typeMap:n.reduce((r,i,a)=>(r[i]=a,r),{}),children:t.map((r,i)=>M(r,`_${i}`)),typeIdForValue:s,offsets:x}),$e=e=>({typeId:c.FixedSizeBinary,stride:e}),Ut=(e,t)=>({typeId:c.FixedSizeList,stride:t,children:[M(e)]}),ve=(e,t)=>({typeId:c.Map,keysSorted:e,children:[t],offsets:x}),Vn=(e,t,n=!1)=>ve(n,X("entries",yt([M(e,"key",!1),M(t,"value")]),!1)),xe=(e=b.MILLISECOND)=>({typeId:c.Duration,unit:L(e,b),values:O}),Oe=()=>({typeId:c.LargeBinary,offsets:O}),Le=()=>({typeId:c.LargeUtf8,offsets:O}),Ee=e=>({typeId:c.LargeList,children:[M(e)],offsets:O}),De=(e,t)=>({typeId:c.RunEndEncoded,children:[Et(M(e,"run_ends"),n=>n.type.typeId===c.Int,()=>"Run-ends must have an integer type."),M(t,"values")]}),Tn=()=>lt(c.BinaryView),Fn=()=>lt(c.Utf8View),Ae=e=>({typeId:c.ListView,children:[M(e,"value")],offsets:x}),Ne=e=>({typeId:c.LargeListView,children:[M(e,"value")],offsets:O}),Se=new tt(2),pt=Se.buffer,jn=new O(pt),Q=new xt(pt),Be=new x(pt),kn=new J(pt);function Rn(e){return e}function V(e){return BigInt(e)}function Me(e){return Ot(e)?V:Rn}function zn(e){return e/864e5|0}function _n(e){return e===b.SECOND?t=>V(t/1e3):e===b.MILLISECOND?V:e===b.MICROSECOND?t=>V(t*1e3):t=>V(t*1e6)}function Yn([e,t,n]){return Be[0]=e,Be[1]=t,jn[1]=V(n),kn}function k(e){if(e>Number.MAX_SAFE_INTEGER||e<Number.MIN_SAFE_INTEGER)throw Error(`BigInt exceeds integer number representation: ${e}`);return Number(e)}function Vt(e,t){return Number(e/t)+Number(e%t)/Number(t)}function Hn(e,t,n,s,r){const i=typeof e=="bigint"?e:V(Math.trunc(e*r));t[n]=i,t[n+1]=i>>64n,s>2&&(t[n+2]=i>>128n,t[n+3]=i>>192n)}const Z=e=>BigInt.asUintN(64,e);function Pn(e,t){const n=t<<1;let s;return BigInt.asIntN(64,e[n+1])<0?(s=Z(~e[n])|Z(~e[n+1])<<64n,s=-(s+1n)):s=e[n]|e[n+1]<<64n,s}function Wn(e,t){const n=t<<2;let s;return BigInt.asIntN(64,e[n+3])<0?(s=Z(~e[n])|Z(~e[n+1])<<64n|Z(~e[n+2])<<128n|Z(~e[n+3])<<192n,s=-(s+1n)):s=e[n]|e[n+1]<<64n|e[n+2]<<128n|e[n+3]<<192n,s}function Gn(e){if(e!==e)return 32256;Se[0]=e;const t=(Q[1]&2147483648)>>16&65535;let n=Q[1]&2146435072,s=0;return n>=1089470464?Q[0]>0?n=31744:(n=(n&2080374784)>>16,s=(Q[1]&1048575)>>10):n<=1056964608?(s=1048576+(Q[1]&1048575),s=1048576+(s<<(n>>20)-998)>>21,n=0):(n=n-1056964608>>10,s=(Q[1]&1048575)+512>>10),t|n|s&65535}const Jn=new TextDecoder("utf-8"),qn=new TextEncoder;function It(e){return Jn.decode(e)}function Ce(e){return qn.encode(e)}function bt(e){return`${typeof e!="object"||!e?e??null:Dn(e)?+e:se(e)?`[${e.map(bt)}]`:Xn(e)}`}function Xn(e){let t="",n=-1;for(const s in e)++n>0&&(t+=","),t+=`"${s}":${bt(e[s])}`;return`{${t}}`}const U=4,Tt=2;function Ue(e,t){return(e[t>>3]&1<<t%8)!==0}function T(e,t){const n=t+I(e,t),s=n-I(e,n),r=$(e,s);return(i,a,u=null)=>{if(i<r){const o=$(e,s+i);if(o)return a(e,n+o)}return u}}function _(e,t){return t}function st(e,t){return!!Kn(e,t)}function Kn(e,t){return Ft(e,t)<<24>>24}function Ft(e,t){return e[t]}function $(e,t){return Qn(e,t)<<16>>16}function Qn(e,t){return e[t]|e[t+1]<<8}function I(e,t){return e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24}function Ve(e,t){return I(e,t)>>>0}function E(e,t){return k(BigInt.asIntN(64,BigInt(Ve(e,t))+(BigInt(Ve(e,t+U))<<32n)))}function gt(e,t){let n=t+I(e,t);const s=I(e,n);return n+=U,It(e.subarray(n,n+s))}function R(e,t,n,s){if(!t)return[];const r=t+I(e,t);return Array.from({length:I(e,r)},(i,a)=>s(e,r+U+a*n))}const jt=Symbol("rowIndex");function kt(e,t){class n{constructor(i){this[jt]=i}toJSON(){return Fe(e,t,this[jt])}}const s=n.prototype;for(let r=0;r<e.length;++r){if(Object.hasOwn(s,e[r]))continue;const i=t[r];Object.defineProperty(s,e[r],{get(){return i.at(this[jt])},enumerable:!0})}return r=>new n(r)}function Te(e,t){return n=>Fe(e,t,n)}function Fe(e,t,n){const s={};for(let r=0;r<e.length;++r)s[e[r]]=t[r].at(n);return s}function Zn(e){return e instanceof it}let rt=class{static ArrayType=null;constructor({length:t,nullCount:n,type:s,validity:r,values:i,offsets:a,sizes:u,children:o}){this.length=t,this.nullCount=n,this.type=s,this.validity=r,this.values=i,this.offsets=a,this.sizes=u,this.children=o,(!n||!this.validity)&&(this.at=d=>this.value(d))}get[Symbol.toStringTag](){return"Batch"}at(t){return this.isValid(t)?this.value(t):null}isValid(t){return Ue(this.validity,t)}value(t){return this.values[t]}slice(t,n){const s=n-t,r=Array(s);for(let i=0;i<s;++i)r[i]=this.at(t+i);return r}*[Symbol.iterator](){for(let t=0;t<this.length;++t)yield this.at(t)}},it=class extends rt{constructor(t){super(t);const{length:n,values:s}=this;this.values=s.subarray(0,n)}slice(t,n){return this.nullCount?super.slice(t,n):this.values.subarray(t,n)}[Symbol.iterator](){return this.nullCount?super[Symbol.iterator]():this.values[Symbol.iterator]()}},Rt=class extends rt{static ArrayType=tt},g=class extends rt{static ArrayType=Array};class je extends g{value(t){return null}}let Y=class extends Rt{value(t){return k(this.values[t])}},ts=class extends Rt{value(t){const n=this.values[t],s=(n&31744)>>10,r=(n&1023)/1024,i=(-1)**((n&32768)>>15);switch(s){case 31:return i*(r?Number.NaN:1/0);case 0:return i*(r?6103515625e-14*r:0)}return i*2**(s-15)*(1+r)}},es=class extends g{value(t){return Ue(this.values,t)}},ke=class extends rt{constructor(t){super(t);const{bitWidth:n,scale:s}=this.type;this.decimal=n===128?Pn:Wn,this.scale=10n**BigInt(s)}},ns=class extends ke{static ArrayType=tt;value(t){return Vt(this.decimal(this.values,t),this.scale)}},ss=class extends ke{static ArrayType=Array;value(t){return this.decimal(this.values,t)}};class Re extends g{constructor(t){super(t),this.source=t}value(t){return new Date(this.source.value(t))}}let rs=class extends Rt{value(t){return 864e5*this.values[t]}};const is=Y;class as extends Y{value(t){return super.value(t)*1e3}}const cs=Y;class us extends Y{value(t){return Vt(this.values[t],1000n)}}class os extends Y{value(t){return Vt(this.values[t],1000000n)}}class ds extends g{value(t){return this.values.subarray(t<<1,t+1<<1)}}class ls extends g{value(t){const n=this.values,s=t<<4;return Float64Array.of(I(n,s),I(n,s+4),E(n,s+8))}}const ze=({values:e,offsets:t},n)=>e.subarray(t[n],t[n+1]),_e=({values:e,offsets:t},n)=>e.subarray(k(t[n]),k(t[n+1]));class hs extends g{value(t){return ze(this,t)}}class fs extends g{value(t){return _e(this,t)}}class ys extends g{value(t){return It(ze(this,t))}}let ps=class extends g{value(t){return It(_e(this,t))}};class Is extends g{value(t){const n=this.offsets;return this.children[0].slice(n[t],n[t+1])}}class bs extends g{value(t){const n=this.offsets;return this.children[0].slice(k(n[t]),k(n[t+1]))}}class gs extends g{value(t){const n=this.offsets[t],s=n+this.sizes[t];return this.children[0].slice(n,s)}}class ms extends g{value(t){const n=this.offsets[t],s=n+this.sizes[t];return this.children[0].slice(k(n),k(s))}}let Ye=class extends g{constructor(t){super(t),this.stride=this.type.stride}};class ws extends Ye{value(t){const{stride:n,values:s}=this;return s.subarray(t*n,(t+1)*n)}}class $s extends Ye{value(t){const{children:n,stride:s}=this;return n[0].slice(t*s,(t+1)*s)}}function He({children:e,offsets:t},n){const[s,r]=e[0].children,i=t[n],a=t[n+1],u=[];for(let o=i;o<a;++o)u.push([s.at(o),r.at(o)]);return u}class vs extends g{value(t){return He(this,t)}}class xs extends g{value(t){return new Map(He(this,t))}}let Pe=class extends g{constructor({typeIds:t,...n}){super(n),this.typeIds=t,this.typeMap=this.type.typeMap}value(t,n=t){const{typeIds:s,children:r,typeMap:i}=this;return r[i[s[t]]].at(n)}};class Os extends Pe{value(t){return super.value(t,this.offsets[t])}}let We=class extends g{constructor(t,n=Te){super(t),this.names=this.type.children.map(s=>s.name),this.factory=n(this.names,this.children)}value(t){return this.factory(t)}};class Ls extends We{constructor(t){super(t,kt)}}class Es extends g{value(t){const[{values:n},s]=this.children;return s.at(Lt(n,t))}}class Ds extends g{setDictionary(t){return this.dictionary=t,this.cache=t.cache(),this}value(t){return this.cache[this.key(t)]}key(t){return this.values[t]}}let Ge=class extends g{constructor({data:t,...n}){super(n),this.data=t}view(t){const{values:n,data:s}=this,r=t<<4;let i=r+4,a=n;const u=I(a,r);return u>12&&(i=I(a,r+12),a=s[I(a,r+8)]),a.subarray(i,i+u)}};class As extends Ge{value(t){return this.view(t)}}class Ns extends Ge{value(t){return It(this.view(t))}}function Je(e){let t=[];return{add(n){return t.push(n),this},clear:()=>t=[],done:()=>new at(t,e)}}let at=class{constructor(t,n=t[0]?.type){this.type=n,this.length=t.reduce((i,a)=>i+a.length,0),this.nullCount=t.reduce((i,a)=>i+a.nullCount,0),this.data=t;const s=t.length,r=new Int32Array(s+1);if(s===1){const[i]=t;r[1]=i.length,this.at=a=>i.at(a)}else for(let i=0,a=0;i<s;++i)r[i+1]=a+=t[i].length;this.offsets=r}get[Symbol.toStringTag](){return"Column"}[Symbol.iterator](){const t=this.data;return t.length===1?t[0][Symbol.iterator]():Ss(t)}at(t){const{data:n,offsets:s}=this,r=Lt(s,t)-1;return n[r]?.at(t-s[r])}get(t){return this.at(t)}toArray(){const{length:t,nullCount:n,data:s}=this,r=!n&&Zn(s[0]),i=s.length;if(r&&i===1)return s[0].values;const a=!i||n>0?Array:s[0].constructor.ArrayType??s[0].values.constructor,u=new a(t);return r?Bs(u,s):Ms(u,s)}cache(){return this._cache??(this._cache=this.toArray())}};function*Ss(e){for(let t=0;t<e.length;++t){const n=e[t][Symbol.iterator]();for(let s=n.next();!s.done;s=n.next())yield s.value}}function Bs(e,t){for(let n=0,s=0;n<t.length;++n){const{values:r}=t[n];e.set(r,s),s+=r.length}return e}function Ms(e,t){let n=-1;for(let s=0;s<t.length;++s){const r=t[s];for(let i=0;i<r.length;++i)e[++n]=r.at(i)}return e}let zt=class vn{constructor(t,n,s=!1){const r=t.fields.map(a=>a.name);this.schema=t,this.names=r,this.children=n,this.factory=s?kt:Te;const i=[];this.getFactory=a=>i[a]??(i[a]=this.factory(r,n.map(u=>u.data[a])))}get[Symbol.toStringTag](){return"Table"}get numCols(){return this.names.length}get numRows(){return this.children[0]?.length??0}getChildAt(t){return this.children[t]}getChild(t){const n=this.names.findIndex(s=>s===t);return n>-1?this.children[n]:void 0}selectAt(t,n=[]){const{children:s,factory:r,schema:i}=this,{fields:a}=i;return new vn({...i,fields:t.map((u,o)=>Cs(a[u],n[o]))},t.map(u=>s[u]),r===kt)}select(t,n){const s=this.names,r=t.map(i=>s.indexOf(i));return this.selectAt(r,n)}toColumns(){const{children:t,names:n}=this,s={};return n.forEach((r,i)=>s[r]=t[i]?.toArray()??[]),s}toArray(){const{children:t,getFactory:n,numRows:s}=this,r=t[0]?.data??[],i=Array(s);for(let a=0,u=-1;a<r.length;++a){const o=n(a);for(let d=0;d<r[a].length;++d)i[++u]=o(d)}return i}*[Symbol.iterator](){const{children:t,getFactory:n}=this,s=t[0]?.data??[];for(let r=0;r<s.length;++r){const i=n(r);for(let a=0;a<s[r].length;++a)yield i(a)}}at(t){const{children:n,getFactory:s,numRows:r}=this;if(t<0||t>=r)return null;const[{offsets:i}]=n,a=Lt(i,t)-1;return s(a)(t-i[a])}get(t){return this.at(t)}};function Cs(e,t){return t!=null&&t!==e.name?{...e,name:t}:e}function mt(e,t={}){const{typeId:n,bitWidth:s,precision:r,unit:i}=e,{useBigInt:a,useDate:u,useDecimalBigInt:o,useMap:d,useProxy:l}=t;switch(n){case c.Null:return je;case c.Bool:return es;case c.Int:case c.Time:case c.Duration:return a||s<64?it:Y;case c.Float:return r?it:ts;case c.Date:return qe(i===j.DAY?rs:is,u&&Re);case c.Timestamp:return qe(i===b.SECOND?as:i===b.MILLISECOND?cs:i===b.MICROSECOND?us:os,u&&Re);case c.Decimal:return o?ss:ns;case c.Interval:return i===B.DAY_TIME?ds:i===B.YEAR_MONTH?it:ls;case c.FixedSizeBinary:return ws;case c.Utf8:return ys;case c.LargeUtf8:return ps;case c.Binary:return hs;case c.LargeBinary:return fs;case c.BinaryView:return As;case c.Utf8View:return Ns;case c.List:return Is;case c.LargeList:return bs;case c.Map:return d?xs:vs;case c.ListView:return gs;case c.LargeListView:return ms;case c.FixedSizeList:return $s;case c.Struct:return l?Ls:We;case c.RunEndEncoded:return Es;case c.Dictionary:return Ds;case c.Union:return e.mode?Os:Pe}throw new Error(q(n))}function qe(e,t){return t?class extends t{constructor(n){super(new e(n))}}:e}function Us(e,t){return{offset:E(e,t),metadataLength:I(e,t+8),bodyLength:E(e,t+16)}}function Xe(e,t){return R(e,t,24,Us)}function Ke(e,t,n){const s=T(e,t);if(s(10,_,0))throw new Error("Record batch compression not implemented");const r=n<S.V4?8:0;return{length:s(4,E,0),nodes:R(e,s(6,_),16,(i,a)=>({length:E(i,a),nullCount:E(i,a+8)})),regions:R(e,s(8,_),16+r,(i,a)=>({offset:E(i,a+r),length:E(i,a+r+8)})),variadic:R(e,s(12,_),8,E)}}function Vs(e,t,n){const s=T(e,t);return{id:s(4,E,0),data:s(6,(r,i)=>Ke(r,i,n)),isDelta:s(8,st,!1)}}function Qe(e,t,n,s){L(n,c,q);const r=T(e,t);switch(n){case c.Binary:return pe();case c.Utf8:return Bt();case c.LargeBinary:return Oe();case c.LargeUtf8:return Le();case c.List:return Ct(s[0]);case c.ListView:return Ae(s[0]);case c.LargeList:return Ee(s[0]);case c.LargeListView:return Ne(s[0]);case c.Struct:return yt(s);case c.RunEndEncoded:return De(s[0],s[1]);case c.Int:return C(r(4,I,0),r(6,st,!1));case c.Float:return nt(r(4,$,z.HALF));case c.Decimal:return be(r(4,I,0),r(6,I,0),r(8,I,128));case c.Date:return ft(r(4,$,j.MILLISECOND));case c.Time:return K(r(4,$,b.MILLISECOND),r(6,I,32));case c.Timestamp:return Mt(r(4,$,b.SECOND),r(6,gt));case c.Interval:return me(r(4,$,B.YEAR_MONTH));case c.Duration:return xe(r(4,$,b.MILLISECOND));case c.FixedSizeBinary:return $e(r(4,I,0));case c.FixedSizeList:return Ut(s[0],r(4,I,0));case c.Map:return ve(r(4,st,!1),s[0]);case c.Union:return we(r(4,$,G.Sparse),s,R(e,r(6,_),4,I))}return{typeId:n}}function _t(e,t){const n=R(e,t,4,(s,r)=>{const i=T(s,r);return[i(4,gt),i(6,gt)]});return n.length?new Map(n):null}function Ze(e,t,n){const s=T(e,t);return{version:n,endianness:s(4,$,0),fields:s(6,Ts,[]),metadata:s(8,_t)}}function Ts(e,t){return R(e,t,4,tn)}function tn(e,t){const n=T(e,t),s=n(8,Ft,c.NONE),r=n(10,_,0),i=n(12,js),a=n(14,(o,d)=>Fs(o,d));let u=Qe(e,r,s,a);return i&&(i.dictionary=u,u=i),{name:n(4,gt),type:u,nullable:n(6,st,!1),metadata:n(16,_t)}}function Fs(e,t){const n=R(e,t,4,tn);return n.length?n:null}function js(e,t){if(!t)return null;const n=T(e,t);return Dt(null,n(6,ks,et()),n(8,st,!1),n(4,E,0))}function ks(e,t){return Qe(e,t,c.Int)}const Rs=(e,t)=>`Expected to read ${e} metadata bytes, but only read ${t}.`,zs=(e,t)=>`Expected to read ${e} bytes for message body, but only read ${t}.`,_s=e=>`Unsupported message type: ${e} (${ae(v,e)})`;function Yt(e,t){let n=I(e,t)||0;if(t+=U,n===-1&&(n=I(e,t)||0,t+=U),n===0)return null;const s=e.subarray(t,t+=n);if(s.byteLength<n)throw new Error(Rs(n,s.byteLength));const r=T(s,0),i=r(4,$,S.V1),a=r(6,Ft,v.NONE),u=r(8,_,0),o=r(10,E,0);let d;if(u){const l=a===v.Schema?Ze:a===v.DictionaryBatch?Vs:a===v.RecordBatch?Ke:null;if(!l)throw new Error(_s(a));if(d=l(s,u,i),o>0){const h=e.subarray(t,t+=o);if(h.byteLength<o)throw new Error(zs(o,h.byteLength));d.body=h}}return{version:i,type:a,index:t,content:d}}function Ys(e){const t=e instanceof ArrayBuffer?new Uint8Array(e):e;return t instanceof Uint8Array&&Hs(t)?Ws(t):Ps(t)}function Hs(e){if(!e||e.length<4)return!1;for(let t=0;t<6;++t)if(ut[t]!==e[t])return!1;return!0}function Ps(e){const t=[e].flat();let n;const s=[],r=[];for(const i of t){if(!(i instanceof Uint8Array))throw new Error("IPC data batch was not a Uint8Array.");let a=0;for(;;){const u=Yt(i,a);if(u===null)break;if(a=u.index,!!u.content)switch(u.type){case v.Schema:n||(n=u.content);break;case v.RecordBatch:s.push(u.content);break;case v.DictionaryBatch:r.push(u.content);break}}}return{schema:n,dictionaries:r,records:s,metadata:null}}function Ws(e){const t=e.byteLength-(ut.length+4),n=I(e,t),s=T(e,t-n),r=s(4,$,S.V1),i=s(8,Xe,[]),a=s(10,Xe,[]);return{schema:s(6,(u,o)=>Ze(u,o,r)),dictionaries:i.map(({offset:u})=>Yt(e,u).content),records:a.map(({offset:u})=>Yt(e,u).content),metadata:s(12,_t)}}function Gs(e,t){return Js(Ys(e),t)}function Js(e,t={}){const{schema:n={fields:[]},dictionaries:s,records:r}=e,{version:i,fields:a}=n,u=new Map,o=Xs(t,i,u),d=new Map;qs(n,y=>{const f=y.type;f.typeId===c.Dictionary&&d.set(f.id,f.dictionary)});const l=new Map;for(const y of s){const{id:f,data:w,isDelta:m,body:H}=y,P=d.get(f),W=Ht(P,o({...w,body:H}));if(l.has(f)){const p=l.get(f);m||p.clear(),p.add(W)}else{if(m)throw new Error("Delta update can not be first dictionary batch.");l.set(f,Je(P).add(W))}}l.forEach((y,f)=>u.set(f,y.done()));const h=a.map(y=>Je(y.type));for(const y of r){const f=o(y);a.forEach((w,m)=>h[m].add(Ht(w.type,f)))}return new zt(n,h.map(y=>y.done()),t.useProxy)}function qs(e,t){e.fields.forEach(function n(s){t(s),s.type.dictionary?.children?.forEach(n),s.type.children?.forEach(n)})}function Xs(e,t,n){const s={version:t,options:e,dictionary:r=>n.get(r)};return r=>{const{length:i,nodes:a,regions:u,variadic:o,body:d}=r;let l=-1,h=-1,y=-1;return{...s,length:i,node:()=>a[++l],buffer:f=>{const{length:w,offset:m}=u[++h];return f?new f(d.buffer,d.byteOffset+m,w/f.BYTES_PER_ELEMENT):d.subarray(m,m+w)},variadic:()=>o[++y],visit(f){return f.map(w=>Ht(w.type,this))}}}}function Ht(e,t){const{typeId:n}=e,{length:s,options:r,node:i,buffer:a,variadic:u,version:o}=t,d=mt(e,r);if(n===c.Null)return new d({length:s,nullCount:s,type:e});const l={...i(),type:e};switch(n){case c.Bool:case c.Int:case c.Time:case c.Duration:case c.Float:case c.Decimal:case c.Date:case c.Timestamp:case c.Interval:case c.FixedSizeBinary:return new d({...l,validity:a(),values:a(e.values)});case c.Utf8:case c.LargeUtf8:case c.Binary:case c.LargeBinary:return new d({...l,validity:a(),offsets:a(e.offsets),values:a()});case c.BinaryView:case c.Utf8View:return new d({...l,validity:a(),values:a(),data:Array.from({length:u()},()=>a())});case c.List:case c.LargeList:case c.Map:return new d({...l,validity:a(),offsets:a(e.offsets),children:t.visit(e.children)});case c.ListView:case c.LargeListView:return new d({...l,validity:a(),offsets:a(e.offsets),sizes:a(e.offsets),children:t.visit(e.children)});case c.FixedSizeList:case c.Struct:return new d({...l,validity:a(),children:t.visit(e.children)});case c.RunEndEncoded:return new d({...l,children:t.visit(e.children)});case c.Dictionary:{const{id:h,indices:y}=e;return new d({...l,validity:a(),values:a(y.values)}).setDictionary(t.dictionary(h))}case c.Union:return o<S.V5&&a(),new d({...l,typeIds:a(dt),offsets:e.mode===G.Sparse?null:a(e.offsets),children:t.visit(e.children)});default:throw new Error(q(n))}}function Pt(e,t,n){e[t]=n,e[t+1]=n>>8,e[t+2]=n>>16,e[t+3]=n>>24}const wt=1024;let Ks=class{constructor(t){this.sink=t,this.minalign=1,this.buf=new Uint8Array(wt),this.space=wt,this.vtables=[],this.outputBytes=0}offset(){return this.buf.length-this.space}writeInt8(t){this.buf[this.space-=1]=t}writeInt16(t){this.buf[this.space-=2]=t,this.buf[this.space+1]=t>>8}writeInt32(t){Pt(this.buf,this.space-=4,t)}writeInt64(t){const n=BigInt(t);this.writeInt32(Number(BigInt.asIntN(32,n>>BigInt(32)))),this.writeInt32(Number(BigInt.asIntN(32,n)))}addInt8(t){F(this,1,0),this.writeInt8(t)}addInt16(t){F(this,2,0),this.writeInt16(t)}addInt32(t){F(this,4,0),this.writeInt32(t)}addInt64(t){F(this,8,0),this.writeInt64(t)}addOffset(t){F(this,U,0),this.writeInt32(this.offset()-t+U)}addObject(t,n){const s=Qs(this,t);return n?.(s),s.finish()}addVector(t,n,s,r){const i=t?.length;if(!i)return 0;F(this,U,n*i),F(this,s,n*i);for(let a=i;--a>=0;)r(this,t[a]);return this.writeInt32(i),this.offset()}addOffsetVector(t){return this.addVector(t,4,4,(n,s)=>n.addOffset(s))}addString(t){if(t==null)return 0;const n=Ce(t),s=n.length;return this.addInt8(0),F(this,U,s),this.buf.set(n,this.space-=s),this.writeInt32(s),this.offset()}finish(t){F(this,this.minalign,U),this.addOffset(t)}flush(){const{buf:t,sink:n}=this,s=t.subarray(this.space,t.length);n.write(s),this.outputBytes+=s.byteLength,this.minalign=1,this.vtables=[],this.buf=new Uint8Array(wt),this.space=wt}addBuffer(t){const n=t.byteLength;if(!n)return 0;this.sink.write(t),this.outputBytes+=n;const s=(n+7&-8)-n;return this.addPadding(s),n+s}addPadding(t){t>0&&(this.sink.write(new Uint8Array(t)),this.outputBytes+=t)}};function F(e,t,n){let{buf:s,space:r,minalign:i}=e;t>i&&(e.minalign=t);const a=s.length,u=a-r+n,o=~u+1&t-1;s=ie(s,u+o+t-1,!0),r+=s.length-a;for(let d=0;d<o;++d)s[--r]=0;e.buf=s,e.space=r}function Qs(e,t){const n=Array(t).fill(0),s=e.offset();function r(i){n[i]=e.offset()}return{addInt8(i,a,u){a!=u&&(e.addInt8(a),r(i))},addInt16(i,a,u){a!=u&&(e.addInt16(a),r(i))},addInt32(i,a,u){a!=u&&(e.addInt32(a),r(i))},addInt64(i,a,u){a!=u&&(e.addInt64(a),r(i))},addOffset(i,a,u){a!=u&&(e.addOffset(a),r(i))},finish(){e.addInt32(0);const i=e.offset();let a=t;for(;--a>=0&&n[a]===0;);const u=a+1;for(;a>=0;--a)e.addInt16(n[a]?i-n[a]:0);const o=2;e.addInt16(i-s);const d=(u+o)*Tt;e.addInt16(d);let l=0;const{buf:h,vtables:y,space:f}=e;t:for(a=0;a<y.length;++a){const w=h.length-y[a];if(d==$(h,w)){for(let m=Tt;m<d;m+=Tt)if($(h,f+m)!=$(h,w+m))continue t;l=y[a];break}}if(l)e.space=h.length-i,Pt(h,e.space,l-i);else{const w=e.offset();y.push(w),Pt(h,h.length-i,w-i)}return i}}}function en(e,t){const{nodes:n,regions:s,variadic:r}=t,i=e.addVector(n,16,8,(o,d)=>(o.writeInt64(d.nullCount),o.writeInt64(d.length),o.offset())),a=e.addVector(s,16,8,(o,d)=>(o.writeInt64(d.length),o.writeInt64(d.offset),o.offset())),u=e.addVector(r,8,8,(o,d)=>o.addInt64(d));return e.addObject(5,o=>{o.addInt64(0,n[0].length,0),o.addOffset(1,i,0),o.addOffset(2,a,0),o.addOffset(4,u,0)})}function Zs(e,t){const n=en(e,t.data);return e.addObject(3,s=>{s.addInt64(0,t.id,0),s.addOffset(1,n,0),s.addInt8(2,+t.isDelta,0)})}function Wt(e,t){return t?.size>0?e.addOffsetVector(Array.from(t,([n,s])=>{const r=e.addString(`${n}`),i=e.addString(`${s}`);return e.addObject(2,a=>{a.addOffset(0,r,0),a.addOffset(1,i,0)})})):0}function $t(e,t){switch(L(t.typeId,c,q)){case c.Dictionary:return lr(e,t);case c.Int:return ir(e,t);case c.Float:return rr(e,t);case c.Decimal:return er(e,t);case c.Date:return tr(e,t);case c.Time:return ur(e,t);case c.Timestamp:return or(e,t);case c.Interval:return ar(e,t);case c.Duration:return nr(e,t);case c.FixedSizeBinary:case c.FixedSizeList:return sr(e,t);case c.Map:return cr(e,t);case c.Union:return dr(e,t)}return e.addObject(0)}function tr(e,t){return e.addObject(1,n=>{n.addInt16(0,t.unit,j.MILLISECOND)})}function er(e,t){return e.addObject(3,n=>{n.addInt32(0,t.precision,0),n.addInt32(1,t.scale,0),n.addInt32(2,t.bitWidth,128)})}function nr(e,t){return e.addObject(1,n=>{n.addInt16(0,t.unit,b.MILLISECOND)})}function sr(e,t){return e.addObject(1,n=>{n.addInt32(0,t.stride,0)})}function rr(e,t){return e.addObject(1,n=>{n.addInt16(0,t.precision,z.HALF)})}function ir(e,t){return e.addObject(2,n=>{n.addInt32(0,t.bitWidth,0),n.addInt8(1,+t.signed,0)})}function ar(e,t){return e.addObject(1,n=>{n.addInt16(0,t.unit,B.YEAR_MONTH)})}function cr(e,t){return e.addObject(1,n=>{n.addInt8(0,+t.keysSorted,0)})}function ur(e,t){return e.addObject(2,n=>{n.addInt16(0,t.unit,b.MILLISECOND),n.addInt32(1,t.bitWidth,32)})}function or(e,t){const n=e.addString(t.timezone);return e.addObject(2,s=>{s.addInt16(0,t.unit,b.SECOND),s.addOffset(1,n,0)})}function dr(e,t){const n=e.addVector(t.typeIds,4,4,(s,r)=>s.addInt32(r));return e.addObject(2,s=>{s.addInt16(0,t.mode,G.Sparse),s.addOffset(1,n,0)})}function lr(e,t){const n=hr(t.indices)?0:$t(e,t.indices);return e.addObject(4,s=>{s.addInt64(0,t.id,0),s.addOffset(1,n,0),s.addInt8(2,+t.ordered,0)})}function hr(e){return e.typeId===c.Int&&e.bitWidth===32&&e.signed}const fr=new Uint16Array(new Uint8Array([1,0]).buffer)[0]===1;function nn(e,t){const{fields:n,metadata:s}=t,r=n.map(u=>sn(e,u)),i=e.addOffsetVector(r),a=Wt(e,s);return e.addObject(4,u=>{u.addInt16(0,+!fr,0),u.addOffset(1,i,0),u.addOffset(2,a,0)})}function sn(e,t){const{name:n,nullable:s,type:r,metadata:i}=t;let{typeId:a}=r,u=0,o=0;if(a!==c.Dictionary)u=$t(e,r);else{const f=r.dictionary;a=f.typeId,o=$t(e,r),u=$t(e,f)}const d=(r.children||[]).map(f=>sn(e,f)),l=e.addOffsetVector(d),h=Wt(e,i),y=e.addString(n);return e.addObject(7,f=>{f.addOffset(0,y,0),f.addInt8(1,+s,0),f.addInt8(2,a,c.NONE),f.addOffset(3,u,0),f.addOffset(4,o,0),f.addOffset(5,l,0),f.addOffset(6,h,0)})}function yr(e,t,n,s,r){const i=Wt(e,r),a=e.addVector(s,24,8,rn),u=e.addVector(n,24,8,rn),o=nn(e,t);e.finish(e.addObject(5,l=>{l.addInt16(0,S.V5,S.V1),l.addOffset(1,o,0),l.addOffset(2,u,0),l.addOffset(3,a,0),l.addOffset(4,i,0)}));const d=e.offset();e.addInt32(0),e.addInt32(-1),e.flush(),e.sink.write(new Uint8Array(Int32Array.of(d).buffer)),e.sink.write(ut)}function rn(e,{offset:t,metadataLength:n,bodyLength:s}){return e.writeInt64(s),e.writeInt32(0),e.writeInt32(n),e.writeInt64(t),e.offset()}function Gt(e,t,n,s,r){e.finish(e.addObject(5,o=>{o.addInt16(0,S.V5,S.V1),o.addInt8(1,t,v.NONE),o.addOffset(2,n,0),o.addInt64(3,s,0)}));const i=8,a=e.offset(),u=a+i+7&-8;r?.push({offset:e.outputBytes,metadataLength:u,bodyLength:s}),e.addInt32(u-i),e.addInt32(-1),e.flush(),e.addPadding(u-a-i)}let pr=class{write(t){}pad(t){this.write(new Uint8Array(t))}finish(){return null}},Ir=class extends pr{constructor(){super(),this.buffers=[]}write(t){this.buffers.push(t)}finish(){const t=this.buffers,n=t.reduce((r,i)=>r+i.byteLength,0),s=new Uint8Array(n);for(let r=0,i=0;r<t.length;++r)s.set(t[r],i),i+=t[r].byteLength;return s}};const an="stream",cn="file";function br(e,{sink:t,format:n=an}={}){if(n!==an&&n!==cn)throw new Error(`Unrecognized Arrow IPC format: ${n}`);const{schema:s,dictionaries:r=[],records:i=[],metadata:a}=e,u=new Ks(t||new Ir),o=n===cn,d=[],l=[];o?u.addBuffer(ut):s&&Gt(u,v.Schema,nn(u,s),0);for(const h of r){const{data:y}=h;Gt(u,v.DictionaryBatch,Zs(u,h),y.byteLength,d),un(u,y.buffers)}for(const h of i)Gt(u,v.RecordBatch,en(u,h),h.byteLength,l),un(u,h.buffers);return o&&yr(u,s,d,l,a),u.sink}function un(e,t){for(let n=0;n<t.length;++n)e.addBuffer(t[n])}function gr(e,t){typeof t=="string"&&(t={format:t});const n=e.children;mr(n);const{dictionaries:s,idMap:r}=$r(n),i=xr(n),a={schema:vr(e.schema,r),dictionaries:s,records:i};return br(a,t).finish()}function mr(e){const t=e[0]?.data.map(n=>n.length);e.forEach(({data:n})=>{if(n.length!==t.length||n.some((s,r)=>s.length!==t[r]))throw new Error("Columns have inconsistent batch sizes.")})}function wr(){let e=0;const t=[],n=[],s=[],r=[];return{node(i,a){t.push({length:i,nullCount:a})},buffer(i){const a=i.byteLength,u=a+7&-8;n.push({offset:e,length:u}),e+=u,s.push(new Uint8Array(i.buffer,i.byteOffset,a))},variadic(i){r.push(i)},children(i,a){i.children.forEach((u,o)=>{dn(u.type,a.children[o],this)})},done(){return{byteLength:e,nodes:t,regions:n,variadic:r,buffers:s}}}}function $r(e){const t=[],n=new Map,s=new Map;let r=-1;const i=a=>{if(n.has(a))s.set(a.type,n.get(a));else{n.set(a,++r);for(let u=0;u<a.data.length;++u)t.push({id:r,isDelta:u>0,data:on([a],u)});s.set(a.type,r)}};return e.forEach(a=>Jt(a.data[0],i)),{dictionaries:t,idMap:s}}function Jt(e,t){if(e?.type.typeId===c.Dictionary){const n=e.dictionary;t(n),Jt(n.data[0],t)}e?.children?.forEach(n=>Jt(n,t))}function vr(e,t){if(!t.size)return e;const n=i=>{i.typeId===c.Dictionary&&(i.id=t.get(i.dictionary),r(i)),i.children&&(i.children=i.children.slice()).forEach(s)},s=(i,a,u)=>{const o={...i.type};u[a]={...i,type:o},n(o)},r=i=>{const a={...i.dictionary};i.dictionary=a,n(a)};return e={...e,fields:e.fields.slice()},e.fields.forEach(s),e}function xr(e){return(e[0]?.data||[]).map((t,n)=>on(e,n))}function on(e,t=0){const n=wr();return e.forEach(s=>{dn(s.type,s.data[t],n)}),n.done()}function dn(e,t,n){const{typeId:s}=e;if(s!==c.Null)switch(n.node(t.length,t.nullCount),s){case c.Bool:case c.Int:case c.Time:case c.Duration:case c.Float:case c.Date:case c.Timestamp:case c.Decimal:case c.Interval:case c.FixedSizeBinary:case c.Dictionary:n.buffer(t.validity),n.buffer(t.values);return;case c.Utf8:case c.LargeUtf8:case c.Binary:case c.LargeBinary:n.buffer(t.validity),n.buffer(t.offsets),n.buffer(t.values);return;case c.BinaryView:case c.Utf8View:n.buffer(t.validity),n.buffer(t.values),n.variadic(t.data.length),t.data.forEach(r=>n.buffer(r));return;case c.List:case c.LargeList:case c.Map:n.buffer(t.validity),n.buffer(t.offsets),n.children(e,t);return;case c.ListView:case c.LargeListView:n.buffer(t.validity),n.buffer(t.offsets),n.buffer(t.sizes),n.children(e,t);return;case c.FixedSizeList:case c.Struct:n.buffer(t.validity),n.children(e,t);return;case c.RunEndEncoded:n.children(e,t);return;case c.Union:{n.buffer(t.typeIds),e.mode===G.Dense&&n.buffer(t.offsets),n.children(e,t);return}default:throw new Error(q(s))}}function D(e){return new ln(e)}class ln{constructor(t=J){this.buf=new t(512)}array(t){return En(this.buf,t)}prep(t){t>=this.buf.length&&(this.buf=ie(this.buf,t))}get(t){return this.buf[t]}set(t,n){this.prep(n),this.buf[n]=t}write(t,n){this.prep(n+t.length),this.buf.set(t,n)}}function hn(){return new Or}let Or=class extends ln{set(t){const n=t>>3;this.prep(n),this.buf[n]|=1<<t%8}};class qt{constructor(t,n){this.type=t,this.ctx=n,this.batchClass=n.batchType(t)}init(){return this.index=-1,this}set(t,n){return this.index=n,!1}done(){return null}batch(){const t=new this.batchClass(this.done());return this.init(),t}}let N=class extends qt{constructor(t,n){super(t,n)}init(){return this.nullCount=0,this.validity=hn(),super.init()}set(t,n){this.index=n;const s=t!=null;return s?this.validity.set(n):this.nullCount++,s}done(){const{index:t,nullCount:n,type:s,validity:r}=this;return{length:t+1,nullCount:n,type:s,validity:n?r.array((t>>3)+1):new J(0)}}};function Xt(){const e=new Map,t=new Set;return{get(n,s){const r=n.id;if(r>=0&&e.has(r))return e.get(r);{const i=Lr(n,s);return r>=0&&e.set(r,i),t.add(i),i}},finish(n){t.forEach(s=>s.finish(n))}}}function Lr(e,t){const n=Object.create(null),s=t.builder(e.dictionary),r=[];s.init();let i=-1;return{type:e,values:s,add(a){return r.push(a),a},key(a){const u=bt(a);let o=n[u];return o===void 0&&(n[u]=o=++i,s.set(a,o)),o},finish(a){const u=e.dictionary,o=new(mt(u,a))(s.done()),d=new at([o]);r.forEach(l=>l.setDictionary(d))}}}class Er extends N{constructor(t,n){super(t,n),this.dict=n.dictionary(t)}init(){return this.values=D(this.type.indices.values),super.init()}set(t,n){super.set(t,n)&&this.values.set(this.dict.key(t),n)}done(){return{...super.done(),values:this.values.array(this.index+1)}}batch(){return this.dict.add(super.batch())}}function Dr(e){const t=Kt();return e(n=>t.add(n)),t.type()}function Kt(){let e=0,t=0,n=0,s=0,r=0,i=0,a=0,u=0,o=0,d=0,l=0,h=1/0,y=-1/0,f=1/0,w=-1/0,m,H,P,W={};return{add(p){if(e++,p==null){t++;return}switch(typeof p){case"string":o++;break;case"number":s++,p<h&&(h=p),p>y&&(y=p),Number.isInteger(p)&&r++;break;case"bigint":i++,m===void 0?m=H=p:(p<m&&(m=p),p>H&&(H=p));break;case"boolean":n++;break;case"object":if(p instanceof Date)a++,+p%864e5===0&&u++;else if(se(p)){d++;const A=p.length;A<f&&(f=A),A>w&&(w=A),P??=Kt(),p.forEach(P.add)}else{l++;for(const A in p)(W[A]??(W[A]=Kt())).add(p[A])}}},type(){const p=e-t;return p===0?oe():r===p?Nr(h,y):s===p?ht():i===p?Sr(m,H):n===p?Ie():u===p?ge():a===p?Mt():o===p?Dt(Bt()):d===p?Ar(P.type(),f,w):l===p?yt(Object.entries(W).map(A=>X(A[0],A[1].type()))):Br()}}}function Ar(e,t,n){return n===t?Ut(e,t):Ct(e)}function Nr(e,t){const n=Math.max(Math.abs(e)-1,t);return n<128?At():n<32768?Nt():n<2**31?et():ht()}function Sr(e,t){const n=-e>t?-e-1n:t;if(n>=2**63)throw new Error(`BigInt exceeds 64 bits: ${n}`);return St()}function Br(){throw new Error("Mixed types detected, please define a union type.")}let fn=class extends N{constructor(t,n){super(t,n),this.toOffset=Me(t.offsets)}init(){return this.offsets=D(this.type.offsets),this.values=D(),this.pos=0,super.init()}set(t,n){const{offsets:s,values:r,toOffset:i}=this;super.set(t,n)&&(r.write(t,this.pos),this.pos+=t.length),s.set(i(this.pos),n+1)}done(){return{...super.done(),offsets:this.offsets.array(this.index+2),values:this.values.array(this.pos+1)}}},Mr=class extends N{constructor(t,n){super(t,n)}init(){return this.values=hn(),super.init()}set(t,n){super.set(t,n),t&&this.values.set(n)}done(){return{...super.done(),values:this.values.array((this.index>>3)+1)}}},Cr=class extends N{constructor(t,n){super(t,n),this.scale=10**t.scale,this.stride=t.bitWidth>>6}init(){return this.values=D(this.type.values),super.init()}set(t,n){const{scale:s,stride:r,values:i}=this;super.set(t,n)&&(i.prep((n+1)*r),Hn(t,i.buf,n*r,r,s))}done(){const{index:t,stride:n,values:s}=this;return{...super.done(),values:s.array((t+1)*n)}}},Ur=class extends N{constructor(t,n){super(t,n),this.stride=t.stride}init(){return this.values=D(),super.init()}set(t,n){super.set(t,n)&&this.values.write(t,n*this.stride)}done(){const{stride:t,values:n}=this;return{...super.done(),values:n.array(t*(this.index+1))}}},Vr=class extends N{constructor(t,n){super(t,n),this.child=n.builder(this.type.children[0].type),this.stride=t.stride}init(){return this.child.init(),super.init()}set(t,n){const{child:s,stride:r}=this,i=n*r;if(super.set(t,n))for(let a=0;a<r;++a)s.set(t[a],i+a);else s.index=i+r}done(){const{child:t}=this;return{...super.done(),children:[t.batch()]}}};class Tr extends N{init(){return this.values=D(this.type.values),super.init()}set(t,n){if(super.set(t,n)){const s=n<<1;this.values.set(t[0],s),this.values.set(t[1],s+1)}}done(){return{...super.done(),values:this.values.array(this.index+1<<1)}}}class Fr extends N{init(){return this.values=D(),super.init()}set(t,n){super.set(t,n)&&this.values.write(Yn(t),n<<4)}done(){return{...super.done(),values:this.values.array(this.index+1<<4)}}}class yn extends N{constructor(t,n,s){super(t,n),this.child=s}init(){this.child.init();const t=this.type.offsets;return this.offsets=D(t),this.toOffset=Me(t),this.pos=0,super.init()}done(){return{...super.done(),offsets:this.offsets.array(this.index+2),children:[this.child.batch()]}}}let jr=class extends yn{constructor(t,n){super(t,n,n.builder(t.children[0].type))}set(t,n){const{child:s,offsets:r,toOffset:i}=this;super.set(t,n)&&t.forEach(a=>s.set(a,this.pos++)),r.set(i(this.pos),n+1)}};class pn extends N{constructor(t,n){super(t,n),this.children=t.children.map(s=>n.builder(s.type))}init(){return this.children.forEach(t=>t.init()),super.init()}done(){const{children:t}=this;return t.forEach(n=>n.index=this.index),{...super.done(),children:t.map(n=>n.batch())}}}let kr=class extends pn{constructor(t,n){super(t,n),this.setters=this.children.map((s,r)=>{const i=t.children[r].name;return(a,u)=>s.set(a?.[i],u)})}set(t,n){super.set(t,n);const s=this.setters;for(let r=0;r<s.length;++r)s[r](t,n)}},Rr=class extends yn{constructor(t,n){super(t,n,new zr(t.children[0].type,n))}set(t,n){const{child:s,offsets:r,toOffset:i}=this;if(super.set(t,n))for(const a of t)s.set(a,this.pos++);r.set(i(this.pos),n+1)}};class zr extends pn{set(t,n){super.set(t,n);const[s,r]=this.children;s.set(t[0],n),r.set(t[1],n)}}const _r={};class Yr extends qt{constructor(t,n){super(t,n),this.children=t.children.map(s=>n.builder(s.type))}init(){return this.pos=0,this.key=null,this.value=_r,this.children.forEach(t=>t.init()),super.init()}next(){const[t,n]=this.children;t.set(this.index+1,this.pos),n.set(this.value,this.pos++)}set(t,n){if(t!==this.value){const s=bt(t);s!==this.key&&(this.key&&this.next(),this.key=s,this.value=t)}this.index=n}done(){this.next();const{children:t,index:n,type:s}=this;return{length:n+1,nullCount:0,type:s,children:t.map(r=>r.batch())}}}class In extends qt{constructor(t,n){super(t,n),this.children=t.children.map(s=>n.builder(s.type)),this.typeMap=t.typeMap,this.lookup=t.typeIdForValue}init(){return this.nullCount=0,this.typeIds=D(dt),this.children.forEach(t=>t.init()),super.init()}set(t,n){const{children:s,lookup:r,typeMap:i,typeIds:a}=this;this.index=n;const u=r(t,n),o=s[i[u]];a.set(u,n),t==null&&++this.nullCount,this.update(t,n,o)}done(){const{children:t,nullCount:n,type:s,typeIds:r}=this,i=this.index+1;return{length:i,nullCount:n,type:s,typeIds:r.array(i),children:t.map(a=>a.batch())}}}class Hr extends In{update(t,n,s){s.set(t,n),this.children.forEach(r=>{r!==s&&r.set(null,n)})}}class Pr extends In{init(){return this.offsets=D(this.type.offsets),super.init()}update(t,n,s){const r=s.index+1;s.set(t,r),this.offsets.set(r,n)}done(){return{...super.done(),offsets:this.offsets.array(this.index+1)}}}let Wr=class extends fn{set(t,n){super.set(t&&Ce(t),n)}};class ct extends N{constructor(t,n){super(t,n),this.values=D(t.values)}init(){return this.values=D(this.type.values),super.init()}set(t,n){super.set(t,n)&&this.values.set(t,n)}done(){return{...super.done(),values:this.values.array(this.index+1)}}}class Gr extends ct{set(t,n){super.set(t==null?t:V(t),n)}}class Qt extends ct{constructor(t,n,s){super(t,n),this.transform=s}set(t,n){super.set(t==null?t:this.transform(t),n)}}function bn(e={},t=Xt()){return{batchType:n=>mt(n,e),builder(n){return gn(n,this)},dictionary(n){return t.get(n,this)},finish:()=>t.finish(e)}}function gn(e,t=bn()){const{typeId:n}=e;switch(n){case c.Int:case c.Time:case c.Duration:return Ot(e.values)?new Gr(e,t):new ct(e,t);case c.Float:return e.precision?new ct(e,t):new Qt(e,t,Gn);case c.Binary:case c.LargeBinary:return new fn(e,t);case c.Utf8:case c.LargeUtf8:return new Wr(e,t);case c.Bool:return new Mr(e,t);case c.Decimal:return new Cr(e,t);case c.Date:return new Qt(e,t,e.unit?V:zn);case c.Timestamp:return new Qt(e,t,_n(e.unit));case c.Interval:switch(e.unit){case B.DAY_TIME:return new Tr(e,t);case B.MONTH_DAY_NANO:return new Fr(e,t)}return new ct(e,t);case c.List:case c.LargeList:return new jr(e,t);case c.Struct:return new kr(e,t);case c.Union:return e.mode?new Pr(e,t):new Hr(e,t);case c.FixedSizeBinary:return new Ur(e,t);case c.FixedSizeList:return new Vr(e,t);case c.Map:return new Rr(e,t);case c.RunEndEncoded:return new Yr(e,t);case c.Dictionary:return new Er(e,t)}throw new Error(q(n))}function mn(e,t,n={},s){const r=An(e)?o=>{for(const d of e)o(d)}:e;t??=Dr(r);const{maxBatchRows:i=1/0,...a}=n;let u;if(t.typeId===c.Null){let o=0;r(()=>++o),u=Jr(t,o,i)}else{const o=bn(a,s),d=gn(t,o).init(),l=y=>u.push(y.batch());u=[];let h=0;r(y=>{d.set(y,h++),h>=i&&(l(d),h=0)}),h&&l(d),o.finish()}return new at(u,t)}function Jr(e,t,n){const s=[],r=u=>new je({length:u,nullCount:u,type:e}),i=Math.floor(t/n);for(let u=0;u<i;++u)s.push(r(n));const a=t%n;return a&&s.push(r(a)),s}function wn(e,t,n={},s){return!t&&ne(e)?qr(e,n):mn(r=>e.forEach(r),t,n,s)}function qr(e,{maxBatchRows:t,useBigInt:n}){const s=e.constructor,r=Xr(s),i=e.length,a=Math.min(t||1/0,i),u=Math.floor(i/a),o=[],d=Ot(s)&&!n?Y:it,l=(y,f)=>o.push(new d({length:f-y,nullCount:0,type:r,validity:new J(0),values:e.subarray(y,f)}));let h=0;for(let y=0;y<u;++y)l(h,h+=a);return h<i&&l(h,i),new at(o)}function Xr(e){switch(e){case ee:return ye();case tt:return ht();case dt:return At();case te:return Nt();case x:return et();case O:return St();case J:return de();case vt:return le();case xt:return he();case ot:return fe()}}function $n(e,t){const n=[],s=Array.isArray(e)?e:Object.entries(e),r=s[0]?.[1].length,i=s.map(([u,o])=>{if(o.length!==r)throw new Error("All columns must have the same length.");return n.push(X(u,o.type)),o}),a={version:S.V5,endianness:Zt.Little,fields:n,metadata:null};return new zt(a,i,t)}function Kr(e,t={}){const{types:n={},...s}=t,r=Xt(),i=(Array.isArray(e)?e:Object.entries(e)).map(([a,u])=>[a,wn(u,n[a],s,r)]);return $n(i,t.useProxy)}export{rt as Batch,at as Column,j as DateUnit,Zt as Endianness,B as IntervalUnit,z as Precision,zt as Table,b as TimeUnit,c as Type,G as UnionMode,S as Version,mt as batchType,pe as binary,Tn as binaryView,Ie as bool,wn as columnFromArray,mn as columnFromValues,ft as date,ge as dateDay,Sn as dateMillisecond,be as decimal,Dt as dictionary,Xt as dictionaryContext,xe as duration,X as field,$e as fixedSizeBinary,Ut as fixedSizeList,nt as float,Nn as float16,ye as float32,ht as float64,C as int,Nt as int16,et as int32,St as int64,At as int8,me as interval,Oe as largeBinary,Ee as largeList,Ne as largeListView,Le as largeUtf8,Ct as list,Ae as listView,Vn as map,oe as nullType,De as runEndEncoded,yt as struct,Kr as tableFromArrays,$n as tableFromColumns,Gs as tableFromIPC,gr as tableToIPC,K as time,Cn as timeMicrosecond,Mn as timeMillisecond,Un as timeNanosecond,Bn as timeSecond,Mt as timestamp,le as uint16,he as uint32,fe as uint64,de as uint8,we as union,Bt as utf8,Fn as utf8View};
